# 第八章 错误处理

[TOC]

## 8.1 概述

1. 必备功能
   - 正确的源程序：通过编译生成目标代码
   - 错误的源程序：通过编译发现并指出错误
2. 错误处理能力
   1. 诊察错误
   2. 报错及时准确
   3. 一次编译能找出错误的多少
   4. 错误的改正能力
   5. 遏止重复的错误信息

## 8.2 错误分类

1. 语法错误

   源程序在语法上不合乎文法

2. 语义错误

   程序不符合语义规则

   - 标识符先声明后引用
   - 标识符引用符合作用域
   - 过程调用时实参与形参类型要兼容
   - 参与运算的操作数类型兼容
   - 下标不能越界

   超越具体计算机系统的限制

   - 数据溢出
   - 符号表、静态存储分配数据区溢出
   - 动态存储分配数据区溢出

## 8.3 错误的诊察和报告

### 8.3.1 错误诊察

1. 违反语法和语义规则以及超过系统限制的错误

   编译程序：语法和语义分析时

2. 下标越界，计算结果溢出以及动态存储数据区溢出

   目标程序：运行时

   对此，编译程序要生成相应的目标程序做检查和进行处理

### 8.3.2 错误报告

1. **出错位置**：源程序中出现错误的位置

   实现：

   行号计数器`line_no`

   单词序号计数器`char_no`

   **诊察到错误时当前计数器内容就是出错位置**

2. **出错性质**：

   - 可直接显示文字信息
   - 可给出错误编码

3. 报告错误的两种方式

   1. 分析完再报告

      编译程序设一保存错误信息的数据区保存诊察到的错误，待分析完后显示错误信息

   2. 边分析边报告

      分析一行源程序时若发现有错，立即输出该行源程序，并在其下输出错误信息。

      > 有时报错不一定十分准确（位置和性质），需进一步分析

## 8.4 错误处理技术

> 发现错误后，在报告错误的同时还要对错误进行处理，以方便编译能进行下去

1. **错误改正**：指编译诊察出错误以后，根据文法进行修正。

   *难以正确改正错误*

2. **错误局部化处理**：编译程序发现错误后，尽可能把错误的影响限制在一个局部的范围，避免错误扩散和影响程序其他部分的分析。

   1. **一般原则**

      > 诊察到错误以后，就暂停对后面符号的分析，跳过错误所在的语法成分然后继续往下分析

      - **词法分析**：

        发现不合法字符，显示错误，并跳过该标识符（单词）继续往下分析。

      - **语法语义分析**：

        跳过所在语法成分（短语或语句），一般是跳到语句右界符，然后从新语句继续往下分析。

   2. **错误局部化处理的实现**（递归下降分析法）

      > cx：全局变量，存放错误信息。

      - 用递归下降分析时，如果发现错误，便将有关错误信息（字符串或编号）送`CX`，然后转出错误处理程序
      - 出错程序先显示出错位置和信息，然后跳过一段源程序直到语句右界符或正在分析的语法成分的合法后继符号为止，然后再往下分析。

   3. **提高错误局部化的方法**

      跳转至直到遇到合法符号集或停止符号集

3. **目标程序运行时错误检测与处理**

   > 下标变量下标值越界
   >
   > 计算结果溢出
   >
   > 动态存储分配数据区溢出

   **编译时生成检测该类错误的代码**

   这类错误难正确报告出错位置，因为目标程序与源程序间难以建立位置上的对应关系

   **一般方法**

   ```txt
   目标程序运行检测到这类错误时，调用异常处理程序，打印错误信息和运行现场（寄存器和存储器中的值）等，然后停止程序运行。
   ```

   

   